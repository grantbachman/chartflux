<html>
	<head>
		{% if title %}
		<title>{{ title }}</title>
		{% else %}
		<title>Welcome to Chartflux!</title>
		{% endif %}
		<script type="text/javascript" src="{{ url_for('static', filename='d3.v3.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='d3.legend.js') }}"></script>
		<style>

	  .axis path { fill: none; stroke: black; }  /* border */
		.axis line { fill: none; stroke: black; }  /* tick marks */
		.grid path { fill: none; stroke: black; }
		.grid line { fill: none; stroke: #eeeeee; }

		/*.xgrid,.ygrid line { fill: none; stroke: #eeeeee; }*/

		.priceline { fill: none;
						stroke: steelblue;
						stroke-width: 1.5px;
		}

		.sma20line { fill: none;
						stroke: green;
						stroke-width: .5px;
		}
		.sma50line { fill: none;
						stroke: orange;
						stroke-width: .5px;
		}
		.sma200line { fill: none;
						stroke: red;
						stroke-width: .5px;
		}
		.legend rect {
		  fill:white;
		  stroke:black;
		  opacity:0.8;
		}

		</style>
	</head>
	<body>
		<b>{{ stock.name }}</b><br />
		From: {{ stock.start }}<br />
		To: {{ stock.end }}<br />
		<br />
	</body>

		<script type="text/javascript">
		var margin = {top: 20, bottom: 50, left: 50, right: 20}
		var svgWidth = 700 - margin.left - margin.right;
		var svgHeight = 500 - margin.top - margin.bottom;
		var parseDate = d3.time.format.iso.parse;

		var dataset = JSON.parse('{{ data }}');

		var minDate = parseDate(dataset[0]['Date']);
		var maxDate = parseDate(dataset[dataset.length - 1]['Date']);
		var minPrice = d3.min(dataset, function(obj) { return obj['Adj Close']; });
		var maxPrice = d3.max(dataset, function(obj) { return obj['Adj Close']; });

		var xScale = d3.time.scale()
												.domain([minDate,maxDate])
									      .range([0, svgWidth]);
		var xAxis = d3.svg.axis()
											.scale(xScale)
											.orient("bottom");

		var yScale = d3.scale.linear()
												.domain([minPrice, maxPrice])
												.range([svgHeight, 0])
												.nice();
		var yAxis = d3.svg.axis().scale(yScale).orient("left");

		var svg = d3.select("body").append("svg")
								.attr("width", svgWidth + margin.left + margin.right)
								.attr("height", svgHeight + margin.left + margin.bottom)
				  			.append("g")
							  .attr("transform", "translate(" + margin.left + ","
																							  + margin.right + ")")

		svg.append("g")
			 .attr("class", "x axis")
			 .attr("transform", "translate(0," + svgHeight + ")")
			 .call(xAxis)
			 .selectAll("text")
			 .style("text-anchor", "end")
			 .attr("transform", "rotate(-65)");

		var xGrid = svg.append("g")
			 .attr("class", "x grid")
			 .call(xAxis.tickSize(svgHeight,0,0).tickFormat(""))


		function currencyFormat(d){
		if (d < 10) { return d3.format("$.2f")(d) }
		else { return d3.format("$.0f")(d) }
		}

		svg.append("g")
			 .attr("class", "y axis")
			 .call(yAxis.tickFormat(function(d) { return currencyFormat(d); }));


		var yGrid = svg.append("g")
			 .attr("class", "y grid")
			 .call(yAxis.tickSize(-svgWidth,0,0).tickFormat(""));

		// Hide the first grid line on each axis.
-   // They were covering up the axis lines
		xGrid.select(".tick").attr("visibility", "hidden");
		yGrid.select(".tick").attr("visibility", "hidden");

		var priceline = d3.svg.line()
				.x(function(d) { return xScale(parseDate(d['Date'])); })
				.y(function(d) { return yScale(d['Adj Close']); })
				.interpolate("linear");

		var sma20line = d3.svg.line()
				.x(function(d) { return xScale(parseDate(d['Date'])); })
				.y(function(d) { return yScale(d['sma20']); })
				.interpolate("linear");

		var sma50line = d3.svg.line()
				.x(function(d) { return xScale(parseDate(d['Date'])); })
				.y(function(d) { return yScale(d['sma50']); })
				.interpolate("linear");

		var sma200line = d3.svg.line()
				.x(function(d) { return xScale(parseDate(d['Date'])); })
				.y(function(d) { return yScale(d['sma200']); })
				.interpolate("linear");

		svg.append("path").attr("class", "priceline")
										  .attr("data-legend", '{{ stock.ticker }}')
											.attr("data-legend-pos",1)
											.attr("d", priceline(dataset))

		svg.append("path").attr("class", "sma20line")
										  .attr("data-legend", '20 Day SMA')
											.attr("data-legend-pos",2)
											.attr("d", sma20line(dataset))
		svg.append("path").attr("class", "sma50line")
										  .attr("data-legend", '50 Day SMA')
											.attr("data-legend-pos",3)
											.attr("d", sma50line(dataset))
		svg.append("path").attr("class", "sma200line")
										  .attr("data-legend", '200 Day SMA')
											.attr("data-legend-pos",4)
											.attr("d", sma200line(dataset))

		svg.append("g").attr("class", "legend")
									 .attr("transform", "translate(50,30)")
									 .call(d3.legend)

		</script>
</html>
